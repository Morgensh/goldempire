<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Empire Richman</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Только базовые сбросы и белый фон */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background: white;
      color: black;
      min-height: 100vh;
      padding-bottom: 72px; /* место под навигацию */
    }

    /* Простой заголовок */
    .header {
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
    }

    /* Основной контент */
    .main-content {
      padding: 0 20px;
    }

    /* Секции — только блок/скрыто */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Карточки — просто белый фон, граница и отступы */
    .card {
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 16px;
    }

    /* Банковская карта — просто прямоугольник */
    .bank-card {
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 24px;
    }

    /* Кликер — просто круглая кнопка */
    .tap-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: white;
      border: 2px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px auto;
      cursor: pointer;
    }

    .tap-text {
      text-align: center;
      margin: 10px 0;
    }

    /* Кнопки — просто прямоугольники */
    .btn {
      padding: 12px;
      background: white;
      border: 1px solid #ccc;
      cursor: pointer;
      margin: 8px 0;
      text-align: center;
    }

    /* Нижняя навигация — просто ряд иконок */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: white;
      border-top: 1px solid #ccc;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      padding: 8px 0;
    }

    .nav-item.active {
      color: black;
      font-weight: bold;
    }

    /* Toast — просто белый блок с текстом */
    #toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 12px 24px;
      border-radius: 4px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #toast.show {
      opacity: 1;
    }

    /* Заголовки секций */
    .section-title {
      font-size: 22px;
      font-weight: bold;
      margin: 20px 0 10px;
    }

    /* Профиль — просто структура */
    .profile-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #eee;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-level, .stat-row {
      margin: 8px 0;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: #eee;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: #ccc;
      width: 0%;
    }

    /* Новый: Для компании и рынка */
    .company-list, .market-list {
      margin-top: 16px;
    }

    .company-item, .market-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .company-avatar, .owner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #eee;
      margin-right: 12px;
    }

    .company-info, .market-info {
      flex: 1;
    }

    .company-name, .market-name {
      font-weight: bold;
    }

    .sub-page {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 10;
      overflow-y: auto;
      padding: 20px;
    }

    .sub-page.active {
      display: block;
    }

    .back-btn {
      margin-bottom: 16px;
      cursor: pointer;
    }

    .tab-container {
      display: flex;
      margin-bottom: 16px;
    }

    .tab {
      padding: 8px 16px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .tab.active {
      background: #eee;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card-list {
      margin-top: 16px;
    }

    .card-item {
      padding: 12px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
    }

    .owned-stock {
      padding: 12px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Верхняя панель -->
  <div class="header">Richman</div>

  <!-- Основной контент -->
  <div class="main-content">
    
    <!-- Главная (кликер) -->
    <div class="section active" id="home-section">
      <!-- Банковская карта -->
      <div class="bank-card">
        <div>RICHMAN</div>
        <div>•••• •••• •••• 1234</div>
        <div>
          <div>Баланс: <span id="card-balance">$ 65,00</span></div>
          <div>Уровень: <span id="card-level">1</span></div>
        </div>
      </div>
      
      <div class="clicker-area">
        <div class="tap-circle" id="tap-circle">
          <i class="fas fa-hand-point-up" style="font-size: 40px;"></i>
        </div>
        <div class="tap-text">Кликайте, чтобы зарабатывать деньги</div>
      </div>
    </div>

    <!-- Бизнес -->
    <div class="section" id="business-section">
      <h2 class="section-title">Бизнес</h2>
      <div class="btn" id="create-company-btn">Создать компанию</div>
      <div class="company-list" id="company-list"></div>
    </div>

    <!-- Рынок -->
    <div class="section" id="market-section">
      <h2 class="section-title">Рынок акций</h2>
      <div class="market-list" id="market-list"></div>
    </div>

    <!-- Кошелек -->
    <div class="section" id="wallet-section">
      <h2 class="section-title">Кошелек</h2>
      <div class="card">
        <div class="stat-row">
          <span>Баланс</span>
          <span id="wallet-balance">$ 65,00</span>
        </div>
        <div class="stat-row">
          <span>Акции</span>
          <span id="wallet-shares-count">0</span>
        </div>
        <div class="stat-row">
          <span>Общая стоимость</span>
          <span id="wallet-total">$ 65,00</span>
        </div>
      </div>
      <div class="owned-stocks" id="owned-stocks"></div>
    </div>

    <!-- Профиль -->
    <div class="section" id="profile-section">
      <h2 class="section-title">Профиль</h2>
      
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">
          <img id="avatar-img" src="" alt="Avatar" style="display: none; width: 100%; height: 100%; border-radius: 50%;">
        </div>
        <div class="profile-name" id="profile-name">Richman Player</div>
        <div class="profile-username" id="profile-username">@username</div>
        <div class="profile-level">Уровень <span id="profile-level">1</span></div>
      </div>

      <div class="card">
        <div class="stat-row">
          <span>ID игрока</span>
          <span id="player-id">#74291</span>
        </div>
        <div class="stat-row">
          <span>Всего кликов</span>
          <span id="total-clicks">0</span>
        </div>
        <div class="stat-row">
          <span>Прогресс до следующего уровня</span>
          <span id="progress-percent">60%</span>
        </div>
      </div>
      
      <div class="card">
        <div class="progress-container">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div style="text-align: center; margin-top: 8px;" id="progress-text">$1 000,00 / $2 000,00</div>
      </div>
    </div>

  </div>

  <!-- Подстраницы -->
  <div class="sub-page" id="create-company-page">
    <div class="back-btn" id="create-company-back"><i class="fas fa-arrow-left"></i> Назад</div>
    <h2>Создать компанию</h2>
    <input type="text" id="company-name-input" placeholder="Название (английские буквы)">
    <div class="btn" id="submit-create-company">Создать</div>
  </div>

  <div class="sub-page" id="company-dashboard-page">
    <div class="back-btn" id="company-dashboard-back"><i class="fas fa-arrow-left"></i> Назад</div>
    <h2 id="company-dashboard-title">Компания</h2>
    <div class="tab-container">
      <div class="tab active" data-tab="info">Инфо</div>
      <div class="tab" data-tab="personnel">Персонал</div>
    </div>
    <div class="tab-content active" id="company-info-tab">
      <div>Акций доступно: <span id="company-shares-available"></span></div>
      <div>Проданных акций: <span id="company-shares-sold"></span></div>
      <div>Клиентов: <span id="company-clients"></span></div>
      <div>Текущая цена: <span id="company-price"></span></div>
      <div class="btn" id="issue-shares-btn">Выпустить новые акции (+1000 за клиента)</div>
    </div>
    <div class="tab-content" id="company-personnel-tab">
      <div class="card-list" id="personnel-cards"></div>
    </div>
  </div>

  <div class="sub-page" id="stock-trade-page">
    <div class="back-btn" id="stock-trade-back"><i class="fas fa-arrow-left"></i> Назад</div>
    <h2 id="stock-trade-title">Торговля акциями</h2>
    <div>Текущая цена: <span id="stock-price"></span></div>
    <div>Доступно акций: <span id="stock-available"></span></div>
    <input type="number" id="buy-amount" placeholder="Количество для покупки">
    <div class="btn" id="buy-shares-btn">Купить</div>
    <input type="number" id="sell-amount" placeholder="Количество для продажи">
    <div class="btn" id="sell-shares-btn">Продать</div>
  </div>

  <div class="sub-page" id="owned-stock-detail-page">
    <div class="back-btn" id="owned-stock-detail-back"><i class="fas fa-arrow-left"></i> Назад</div>
    <h2 id="owned-stock-detail-title">Детали акций</h2>
    <div>Владеете: <span id="owned-shares"></span></div>
    <div>Текущая цена: <span id="owned-price"></span></div>
    <div>Доход (ежедневный): <span id="owned-income"></span></div>
    <div class="btn" id="sell-all-btn">Продать все</div>
  </div>

  <!-- Нижняя навигация -->
  <div class="bottom-nav">
    <div class="nav-item active" data-section="home">
      <i class="fas fa-home"></i>
      <span>Главная</span>
    </div>
    <div class="nav-item" data-section="business">
      <i class="fas fa-building"></i>
      <span>Бизнес</span>
    </div>
    <div class="nav-item" data-section="market">
      <i class="fas fa-chart-line"></i>
      <span>Рынок</span>
    </div>
    <div class="nav-item" data-section="wallet">
      <i class="fas fa-wallet"></i>
      <span>Кошелек</span>
    </div>
    <div class="nav-item" data-section="profile">
      <i class="fas fa-user"></i>
      <span>Профиль</span>
    </div>
  </div>

  <!-- Toast уведомление -->
  <div id="toast"></div>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Глобальные переменные
    let userData = tg.initDataUnsafe.user || {};
    let telegramId = userData.id || 0;
    let balance = 65.00;
    let clickValue = 2.50;
    let level = 1;
    let progress = 600;
    let totalClicks = 0;
    let apiBase = 'https://dinod.ru/api';
    let currentCompanyId = null;
    let currentStockCompanyId = null;
    let currentOwnedStockCompanyId = null;
    let userCompanies = [];
    let marketCompanies = [];
    let ownedStocks = [];

    // DOM элементы
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const tapCircle = document.getElementById('tap-circle');
    const cardBalanceEl = document.getElementById('card-balance');
    const cardLevelEl = document.getElementById('card-level');
    const progressFillEl = document.getElementById('progress-fill');
    const progressTextEl = document.getElementById('progress-text');
    const progressPercentEl = document.getElementById('progress-percent');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const walletTotalEl = document.getElementById('wallet-total');
    const walletSharesCountEl = document.getElementById('wallet-shares-count');
    const profileLevelEl = document.getElementById('profile-level');
    const totalClicksEl = document.getElementById('total-clicks');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileUsernameEl = document.getElementById('profile-username');
    const playerIdEl = document.getElementById('player-id');
    const avatarImgEl = document.getElementById('avatar-img');
    const createCompanyBtn = document.getElementById('create-company-btn');
    const companyListEl = document.getElementById('company-list');
    const marketListEl = document.getElementById('market-list');
    const ownedStocksEl = document.getElementById('owned-stocks');
    const createCompanyPage = document.getElementById('create-company-page');
    const createCompanyBack = document.getElementById('create-company-back');
    const companyNameInput = document.getElementById('company-name-input');
    const submitCreateCompany = document.getElementById('submit-create-company');
    const companyDashboardPage = document.getElementById('company-dashboard-page');
    const companyDashboardBack = document.getElementById('company-dashboard-back');
    const companyDashboardTitle = document.getElementById('company-dashboard-title');
    const companySharesAvailable = document.getElementById('company-shares-available');
    const companySharesSold = document.getElementById('company-shares-sold');
    const companyClients = document.getElementById('company-clients');
    const companyPrice = document.getElementById('company-price');
    const issueSharesBtn = document.getElementById('issue-shares-btn');
    const personnelCardsEl = document.getElementById('personnel-cards');
    const stockTradePage = document.getElementById('stock-trade-page');
    const stockTradeBack = document.getElementById('stock-trade-back');
    const stockTradeTitle = document.getElementById('stock-trade-title');
    const stockPrice = document.getElementById('stock-price');
    const stockAvailable = document.getElementById('stock-available');
    const buyAmount = document.getElementById('buy-amount');
    const buySharesBtn = document.getElementById('buy-shares-btn');
    const sellAmount = document.getElementById('sell-amount');
    const sellSharesBtn = document.getElementById('sell-shares-btn');
    const ownedStockDetailPage = document.getElementById('owned-stock-detail-page');
    const ownedStockDetailBack = document.getElementById('owned-stock-detail-back');
    const ownedStockDetailTitle = document.getElementById('owned-stock-detail-title');
    const ownedShares = document.getElementById('owned-shares');
    const ownedPrice = document.getElementById('owned-price');
    const ownedIncome = document.getElementById('owned-income');
    const sellAllBtn = document.getElementById('sell-all-btn');

    const tabs = companyDashboardPage.querySelectorAll('.tab');
    const tabContents = companyDashboardPage.querySelectorAll('.tab-content');

    // Переключение разделов
    function switchToSection(sectionId) {
      sections.forEach(section => section.classList.remove('active'));
      navItems.forEach(item => item.classList.remove('active'));
      
      document.getElementById(`${sectionId}-section`).classList.add('active');
      document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
      
      if (sectionId === 'business') loadUserCompanies();
      if (sectionId === 'market') loadMarket();
      if (sectionId === 'wallet') loadOwnedStocks();
      updateUI();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.getAttribute('data-section');
        switchToSection(sectionId);
      });
    });

    // Обработка клика
    async function handleClick() {
      if (!telegramId) return;

      try {
        const response = await fetch(`${apiBase}/click/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance, total_clicks: totalClicks })
        });
        const updatedUser = await response.json();
        if (updatedUser) {
          balance = parseFloat(updatedUser.balance);
          level = updatedUser.level;
          progress = parseFloat(updatedUser.progress);
          totalClicks = updatedUser.total_clicks;
          clickValue = 2.50 * level;
        }
      } catch (err) {
        console.error('Click error:', err);
      }

      updateUI();

      // Простая анимация масштаба
      tapCircle.animate([
        { transform: 'scale(1)' },
        { transform: 'scale(0.95)' },
        { transform: 'scale(1)' }
      ], { duration: 200 });
    }

    tapCircle.addEventListener('click', handleClick);

    // Обновление UI
    function updateUI() {
      const formattedBalance = '$ ' + balance.toFixed(2).replace('.', ',');
      cardBalanceEl.textContent = formattedBalance;
      walletBalanceEl.textContent = formattedBalance;
      cardLevelEl.textContent = level;
      profileLevelEl.textContent = level;
      
      const nextThreshold = level * 1000;
      const progressPercent = Math.min(100, Math.round((progress / nextThreshold) * 100));
      progressFillEl.style.width = `${progressPercent}%`;
      progressTextEl.textContent = `$${progress.toFixed(0)} / $${nextThreshold.toFixed(0)}`;
      progressPercentEl.textContent = `${progressPercent}%`;

      walletTotalEl.textContent = formattedBalance;
      totalClicksEl.textContent = totalClicks;

      // Для профиля
      profileNameEl.textContent = userData.first_name || 'Richman Player';
      profileUsernameEl.textContent = `@${userData.username || 'username'}`;
      playerIdEl.textContent = `#${telegramId}`;
      if (userData.photo_url) {
        avatarImgEl.src = userData.photo_url;
        avatarImgEl.style.display = 'block';
      }
    }

    // Toast уведомления
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Загрузка данных пользователя
    async function loadUserData() {
      try {
        const response = await fetch(`${apiBase}/user/${telegramId}`);
        const user = await response.json();
        if (user) {
          balance = parseFloat(user.balance);
          level = user.level;
          progress = parseFloat(user.progress);
          totalClicks = user.total_clicks;
          clickValue = 2.50 * level;
          updateUI();
        }
      } catch (err) {
        console.error('Load user error:', err);
      }
    }

    // Создание компании
    createCompanyBtn.addEventListener('click', () => {
      createCompanyPage.classList.add('active');
    });

    createCompanyBack.addEventListener('click', () => {
      createCompanyPage.classList.remove('active');
    });

    submitCreateCompany.addEventListener('click', async () => {
      const name = companyNameInput.value.trim();
      if (!/^[a-zA-Z0-9]+$/.test(name)) {
        showToast('Название должно содержать только английские буквы и цифры');
        return;
      }
      try {
        const response = await fetch(`${apiBase}/companies/create/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const result = await response.json();
        if (result.error) {
          showToast(result.error);
        } else {
          showToast('Компания создана!');
          createCompanyPage.classList.remove('active');
          loadUserCompanies();
        }
      } catch (err) {
        showToast('Ошибка создания');
      }
    });

    // Загрузка компаний пользователя
    async function loadUserCompanies() {
      try {
        const response = await fetch(`${apiBase}/companies/user/${telegramId}`);
        userCompanies = await response.json();
        companyListEl.innerHTML = '';
        userCompanies.forEach(company => {
          const item = document.createElement('div');
          item.classList.add('company-item');
          item.innerHTML = `
            <div class="company-avatar"></div>
            <div class="company-info">
              <div class="company-name">${company.name}</div>
              <div>Клиентов: ${company.clients_count}</div>
            </div>
          `;
          item.addEventListener('click', () => {
            currentCompanyId = company.id;
            loadCompanyDashboard();
            companyDashboardPage.classList.add('active');
          });
          companyListEl.appendChild(item);
        });
      } catch (err) {
        console.error('Load companies error:', err);
      }
    }

    // Личный кабинет компании
    async function loadCompanyDashboard() {
      try {
        const response = await fetch(`${apiBase}/companies/${currentCompanyId}`);
        const company = await response.json();
        companyDashboardTitle.textContent = company.name;
        companySharesAvailable.textContent = company.shares_available;
        companySharesSold.textContent = company.shares_sold;
        companyClients.textContent = company.clients_count;
        companyPrice.textContent = `$${company.current_price.toFixed(2)}`;

        // Персонал (карточки)
        const cardsResponse = await fetch(`${apiBase}/personnel/${currentCompanyId}`);
        const cards = await cardsResponse.json();
        personnelCardsEl.innerHTML = '';
        cards.forEach(card => {
          const item = document.createElement('div');
          item.classList.add('card-item');
          item.innerHTML = `
            <div>${card.name} (Уровень: ${card.level})</div>
            <div>Стоимость улучшения: $${card.upgrade_cost.toFixed(2)}</div>
            <div class="btn upgrade-card-btn" data-card-id="${card.id}">Улучшить</div>
          `;
          personnelCardsEl.appendChild(item);
        });

        // Добавляем обработчики улучшения
        personnelCardsEl.querySelectorAll('.upgrade-card-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cardId = btn.dataset.cardId;
            try {
              const res = await fetch(`${apiBase}/personnel/upgrade/${cardId}/${telegramId}`, { method: 'POST' });
              const result = await res.json();
              if (result.error) {
                showToast(result.error);
              } else {
                showToast('Карточка улучшена!');
                loadCompanyDashboard();
                loadUserData(); // Обновить баланс
              }
            } catch (err) {
              showToast('Ошибка улучшения');
            }
          });
        });
      } catch (err) {
        console.error('Load dashboard error:', err);
      }
    }

    companyDashboardBack.addEventListener('click', () => {
      companyDashboardPage.classList.remove('active');
    });

    // Выпуск новых акций
    issueSharesBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`${apiBase}/companies/issue-shares/${currentCompanyId}/${telegramId}`, { method: 'POST' });
        const result = await response.json();
        if (result.error) {
          showToast(result.error);
        } else {
          showToast('Новые акции выпущены!');
          loadCompanyDashboard();
        }
      } catch (err) {
        showToast('Ошибка выпуска');
      }
    });

    // Переключение табов в дашборде
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(c => c.classList.remove('active'));
        document.getElementById(`company-${tab.dataset.tab}-tab`).classList.add('active');
      });
    });

    // Загрузка рынка
    async function loadMarket() {
      try {
        const response = await fetch(`${apiBase}/market`);
        marketCompanies = await response.json();
        // Сортировка по успеху (на основе суммарного уровня карточек)
        marketCompanies.sort((a, b) => b.success_score - a.success_score);
        marketListEl.innerHTML = '';
        marketCompanies.forEach(company => {
          const item = document.createElement('div');
          item.classList.add('market-item');
          item.innerHTML = `
            <img class="owner-avatar" src="${company.owner_avatar || ''}" alt="Avatar">
            <div class="market-info">
              <div class="market-name">${company.name} (@${company.owner_username})</div>
              <div>Клиентов: ${company.clients_count}</div>
              <div>Цена: $${company.current_price.toFixed(2)}</div>
            </div>
          `;
          item.addEventListener('click', () => {
            currentStockCompanyId = company.id;
            loadStockTrade();
            stockTradePage.classList.add('active');
          });
          marketListEl.appendChild(item);
        });
      } catch (err) {
        console.error('Load market error:', err);
      }
    }

    // Торговля акциями
    async function loadStockTrade() {
      try {
        const response = await fetch(`${apiBase}/companies/${currentStockCompanyId}`);
        const company = await response.json();
        stockTradeTitle.textContent = `Акции ${company.name}`;
        stockPrice.textContent = `$${company.current_price.toFixed(2)}`;
        stockAvailable.textContent = company.shares_available;

        // Получить owned shares для продажи
        const ownedResponse = await fetch(`${apiBase}/stocks/owned/${telegramId}/${currentStockCompanyId}`);
        const owned = await ownedResponse.json();
        sellAmount.max = owned.shares_owned || 0;
      } catch (err) {
        console.error('Load trade error:', err);
      }
    }

    stockTradeBack.addEventListener('click', () => {
      stockTradePage.classList.remove('active');
    });

    buySharesBtn.addEventListener('click', async () => {
      const amount = parseInt(buyAmount.value);
      if (amount <= 0) return;
      try {
        const response = await fetch(`${apiBase}/stocks/buy/${telegramId}/${currentStockCompanyId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });
        const result = await response.json();
        if (result.error) {
          showToast(result.error);
        } else {
          showToast('Акции куплены!');
          loadStockTrade();
          loadUserData();
          buyAmount.value = '';
        }
      } catch (err) {
        showToast('Ошибка покупки');
      }
    });

    sellSharesBtn.addEventListener('click', async () => {
      const amount = parseInt(sellAmount.value);
      if (amount <= 0) return;
      try {
        const response = await fetch(`${apiBase}/stocks/sell/${telegramId}/${currentStockCompanyId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });
        const result = await response.json();
        if (result.error) {
          showToast(result.error);
        } else {
          showToast('Акции проданы!');
          loadStockTrade();
          loadUserData();
          sellAmount.value = '';
        }
      } catch (err) {
        showToast('Ошибка продажи');
      }
    });

    // Загрузка owned stocks
    async function loadOwnedStocks() {
      try {
        const response = await fetch(`${apiBase}/stocks/owned/${telegramId}`);
        ownedStocks = await response.json();
        ownedStocksEl.innerHTML = '';
        let totalShares = 0;
        ownedStocks.forEach(stock => {
          totalShares += stock.shares_owned;
          const item = document.createElement('div');
          item.classList.add('owned-stock');
          item.innerHTML = `
            <div>${stock.company_name}</div>
            <div>Владеете: ${stock.shares_owned}</div>
            <div>Цена: $${stock.current_price.toFixed(2)}</div>
          `;
          item.addEventListener('click', () => {
            currentOwnedStockCompanyId = stock.company_id;
            loadOwnedStockDetail();
            ownedStockDetailPage.classList.add('active');
          });
          ownedStocksEl.appendChild(item);
        });
        walletSharesCountEl.textContent = totalShares;
      } catch (err) {
        console.error('Load owned stocks error:', err);
      }
    }

    // Детали owned stock
    async function loadOwnedStockDetail() {
      try {
        const response = await fetch(`${apiBase}/stocks/owned/${telegramId}/${currentOwnedStockCompanyId}`);
        const stock = await response.json();
        ownedStockDetailTitle.textContent = `Акции ${stock.company_name}`;
        ownedShares.textContent = stock.shares_owned;
        ownedPrice.textContent = `$${stock.current_price.toFixed(2)}`;
        ownedIncome.textContent = `$${stock.daily_income.toFixed(2)}`; // Рассчитывается на бэке
      } catch (err) {
        console.error('Load owned detail error:', err);
      }
    }

    ownedStockDetailBack.addEventListener('click', () => {
      ownedStockDetailPage.classList.remove('active');
    });

    sellAllBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`${apiBase}/stocks/sell-all/${telegramId}/${currentOwnedStockCompanyId}`, { method: 'POST' });
        const result = await response.json();
        if (result.error) {
          showToast(result.error);
        } else {
          showToast('Все акции проданы!');
          ownedStockDetailPage.classList.remove('active');
          loadOwnedStocks();
          loadUserData();
        }
      } catch (err) {
        showToast('Ошибка продажи');
      }
    });

    // Инициализация
    loadUserData();
    updateUI();
  </script>

</body>
</html>
