<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Empire Richman</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background: white;
      color: black;
      min-height: 100vh;
      padding-bottom: 72px;
    }

    .header {
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
    }

    .main-content {
      padding: 0 20px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .card {
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 16px;
    }

    .bank-card {
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 24px;
    }

    .tap-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: white;
      border: 2px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px auto;
      cursor: pointer;
    }

    .tap-text {
      text-align: center;
      margin: 10px 0;
    }

    .btn {
      padding: 12px;
      background: white;
      border: 1px solid #ccc;
      cursor: pointer;
      margin: 8px 0;
      text-align: center;
    }

    .bottom-nav {
      display: flex;
      justify-content: space-around;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: white;
      border-top: 1px solid #ccc;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      padding: 8px 0;
    }

    .nav-item.active {
      color: black;
      font-weight: bold;
    }

    #toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 12px 24px;
      border-radius: 4px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #toast.show {
      opacity: 1;
    }

    .section-title {
      font-size: 22px;
      font-weight: bold;
      margin: 20px 0 10px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #eee;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: #eee;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: #ccc;
      width: 0%;
    }

    /* Стили для модальных окон и страниц */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      z-index: 2000;
      display: none;
      flex-direction: column;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: bold;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
    }

    .input-field {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
    }

    .stock-item {
      padding: 16px;
      border: 1px solid #ccc;
      margin: 8px 0;
      cursor: pointer;
    }

    .stock-info {
      margin: 8px 0;
    }

    .wallet-stock-item {
      padding: 16px;
      border: 1px solid #ccc;
      margin: 8px 0;
    }

    .wallet-stock-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <!-- Верхняя панель -->
  <div class="header">Richman</div>

  <!-- Основной контент -->
  <div class="main-content">
    
    <!-- Главная (кликер) -->
    <div class="section active" id="home-section">
      <div class="bank-card">
        <div>RICHMAN</div>
        <div>•••• •••• •••• 1234</div>
        <div>
          <div>Баланс: <span id="card-balance">$ 65,00</span></div>
          <div>Уровень: <span id="card-level">1</span></div>
        </div>
      </div>
      
      <div class="clicker-area">
        <div class="tap-circle" id="tap-circle">
          <i class="fas fa-hand-point-up" style="font-size: 40px;"></i>
        </div>
        <div class="tap-text">Кликайте, чтобы зарабатывать деньги</div>
      </div>
    </div>

    <!-- Бизнес -->
    <div class="section" id="business-section">
      <h2 class="section-title">Бизнес</h2>
      <div id="business-list">
        <!-- Список компаний будет здесь -->
      </div>
      <button class="btn" id="create-company-btn">Создать компанию</button>
    </div>

    <!-- Рынок -->
    <div class="section" id="market-section">
      <h2 class="section-title">Рынок акций</h2>
      <div id="market-list">
        <!-- Список акций будет здесь -->
      </div>
    </div>

    <!-- Кошелек -->
    <div class="section" id="wallet-section">
      <h2 class="section-title">Кошелек</h2>
      <div class="card">
        <div class="stat-row">
          <span>Баланс</span>
          <span id="wallet-balance">$ 65,00</span>
        </div>
        <div class="stat-row">
          <span>Акции</span>
          <span id="wallet-stocks-count">0</span>
        </div>
        <div class="stat-row">
          <span>Общая стоимость</span>
          <span id="wallet-total">$ 65,00</span>
        </div>
      </div>
      <div id="wallet-stocks-list">
        <!-- Акции в кошельке -->
      </div>
    </div>

    <!-- Профиль -->
    <div class="section" id="profile-section">
      <h2 class="section-title">Профиль</h2>
      
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">
          <img id="avatar-img" src="" alt="Avatar" style="display: none; width: 100%; height: 100%; border-radius: 50%;">
        </div>
        <div class="profile-name" id="profile-name">Richman Player</div>
        <div class="profile-username" id="profile-username">@username</div>
        <div class="profile-level">Уровень <span id="profile-level">1</span></div>
      </div>

      <div class="card">
        <div class="stat-row">
          <span>ID игрока</span>
          <span id="player-id">#74291</span>
        </div>
        <div class="stat-row">
          <span>Всего кликов</span>
          <span id="total-clicks">0</span>
        </div>
        <div class="stat-row">
          <span>Прогресс до следующего уровня</span>
          <span id="progress-percent">60%</span>
        </div>
      </div>
      
      <div class="card">
        <div class="progress-container">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div style="text-align: center; margin-top: 8px;" id="progress-text">$1 000,00 / $2 000,00</div>
      </div>
    </div>

  </div>

  <!-- Нижняя навигация -->
  <div class="bottom-nav">
    <div class="nav-item active" data-section="home">
      <i class="fas fa-home"></i>
      <span>Главная</span>
    </div>
    <div class="nav-item" data-section="business">
      <i class="fas fa-building"></i>
      <span>Бизнес</span>
    </div>
    <div class="nav-item" data-section="market">
      <i class="fas fa-chart-line"></i>
      <span>Рынок</span>
    </div>
    <div class="nav-item" data-section="wallet">
      <i class="fas fa-wallet"></i>
      <span>Кошелек</span>
    </div>
    <div class="nav-item" data-section="profile">
      <i class="fas fa-user"></i>
      <span>Профиль</span>
    </div>
  </div>

  <!-- Toast уведомление -->
  <div id="toast"></div>

  <!-- Модальное окно создания компании -->
  <div class="modal" id="create-company-modal">
    <div class="modal-header">
      <div class="modal-title">Создать компанию</div>
      <div class="modal-close" id="close-create-modal">&times;</div>
    </div>
    <input type="text" class="input-field" id="company-name-input" placeholder="Название компании (только английские буквы)">
    <button class="btn" id="confirm-create-company">Создать</button>
  </div>

  <!-- Личный кабинет компании -->
  <div class="modal" id="company-cabinet-modal">
    <div class="modal-header">
      <div class="modal-title" id="company-cabinet-title">Личный кабинет компании</div>
      <div class="modal-close" id="close-company-cabinet">&times;</div>
    </div>
    <div class="card">
      <div class="stat-row">
        <span>Название</span>
        <span id="cabinet-company-name">-</span>
      </div>
      <div class="stat-row">
        <span>Клиентов</span>
        <span id="cabinet-clients">0</span>
      </div>
      <div class="stat-row">
        <span>Выпущено акций</span>
        <span id="cabinet-issued">0</span>
      </div>
      <div class="stat-row">
        <span>Доступно к выпуску</span>
        <span id="cabinet-available">0</span>
      </div>
    </div>
    <button class="btn" id="issue-more-shares">Выпустить ещё акций</button>
  </div>

  <!-- Страница акции на рынке -->
  <div class="modal" id="stock-detail-modal">
    <div class="modal-header">
      <div class="modal-title" id="stock-detail-title">Акция</div>
      <div class="modal-close" id="close-stock-detail">&times;</div>
    </div>
    <div class="card">
      <div class="stat-row">
        <span>Компания</span>
        <span id="stock-company-name">-</span>
      </div>
      <div class="stat-row">
        <span>Владелец</span>
        <span id="stock-owner">-</span>
      </div>
      <div class="stat-row">
        <span>Клиентов</span>
        <span id="stock-clients">0</span>
      </div>
      <div class="stat-row">
        <span>Цена за акцию</span>
        <span id="stock-price">-</span>
      </div>
      <div class="stat-row">
        <span>Количество</span>
        <input type="number" class="input-field" id="buy-amount" value="1" min="1">
      </div>
    </div>
    <button class="btn" id="buy-stock-btn">Купить</button>
  </div>

  <script>
    // Telegram WebApp init
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Глобальные переменные
    let userData = tg.initDataUnsafe.user || {};
    let telegramId = userData.id || 0;
    let balance = 65.00;
    let clickValue = 2.50;
    let level = 1;
    let progress = 600;
    let totalClicks = 0;
    let apiBase = 'https://dinod.ru/api';

    // Новые глобальные переменные
    let companies = []; // [{ id, name, ownerId, issuedShares, clients }]
    let ownedStocks = []; // [{ companyId, companyName, amount, buyPrice, currentPrice }]
    let marketStocks = []; // [{ companyId, companyName, ownerId, clients, price }]

    // DOM элементы
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const tapCircle = document.getElementById('tap-circle');
    const cardBalanceEl = document.getElementById('card-balance');
    const cardLevelEl = document.getElementById('card-level');
    const progressFillEl = document.getElementById('progress-fill');
    const progressTextEl = document.getElementById('progress-text');
    const progressPercentEl = document.getElementById('progress-percent');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const walletTotalEl = document.getElementById('wallet-total');
    const walletStocksCountEl = document.getElementById('wallet-stocks-count');
    const profileLevelEl = document.getElementById('profile-level');
    const totalClicksEl = document.getElementById('total-clicks');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileUsernameEl = document.getElementById('profile-username');
    const playerIdEl = document.getElementById('player-id');
    const avatarImgEl = document.getElementById('avatar-img');

    // Модальные окна
    const createCompanyModal = document.getElementById('create-company-modal');
    const companyCabinetModal = document.getElementById('company-cabinet-modal');
    const stockDetailModal = document.getElementById('stock-detail-modal');

    // Кнопки
    const createCompanyBtn = document.getElementById('create-company-btn');
    const closeCreateModal = document.getElementById('close-create-modal');
    const confirmCreateCompany = document.getElementById('confirm-create-company');
    const closeCompanyCabinet = document.getElementById('close-company-cabinet');
    const closeStockDetail = document.getElementById('close-stock-detail');
    const buyStockBtn = document.getElementById('buy-stock-btn');
    const issueMoreSharesBtn = document.getElementById('issue-more-shares');

    // Поля ввода
    const companyNameInput = document.getElementById('company-name-input');
    const buyAmountInput = document.getElementById('buy-amount');

    // Переключение разделов
    function switchToSection(sectionId) {
      sections.forEach(section => section.classList.remove('active'));
      navItems.forEach(item => item.classList.remove('active'));
      
      document.getElementById(`${sectionId}-section`).classList.add('active');
      document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
      
      updateUI();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.getAttribute('data-section');
        switchToSection(sectionId);
      });
    });

    // Обработка клика
    async function handleClick() {
      if (!telegramId) return;

      try {
        const response = await fetch(`${apiBase}/click/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance, total_clicks: totalClicks })
        });
        const updatedUser = await response.json();
        if (updatedUser) {
          balance = parseFloat(updatedUser.balance);
          level = updatedUser.level;
          progress = parseFloat(updatedUser.progress);
          totalClicks = updatedUser.total_clicks;
          clickValue = 2.50 * level;
        }
      } catch (err) {
        console.error('Click error:', err);
      }

      updateUI();

      tapCircle.animate([
        { transform: 'scale(1)' },
        { transform: 'scale(0.95)' },
        { transform: 'scale(1)' }
      ], { duration: 200 });
    }

    tapCircle.addEventListener('click', handleClick);

    // Обновление UI
    function updateUI() {
      const formattedBalance = '$ ' + balance.toFixed(2).replace('.', ',');
      cardBalanceEl.textContent = formattedBalance;
      walletBalanceEl.textContent = formattedBalance;
      cardLevelEl.textContent = level;
      profileLevelEl.textContent = level;
      
      const nextThreshold = level * 1000;
      const progressPercent = Math.min(100, Math.round((progress / nextThreshold) * 100));
      progressFillEl.style.width = `${progressPercent}%`;
      progressTextEl.textContent = `$${progress.toFixed(0)} / $${nextThreshold.toFixed(0)}`;
      progressPercentEl.textContent = `${progressPercent}%`;

      // Обновляем кошелёк
      let totalStocksValue = 0;
      ownedStocks.forEach(stock => {
        totalStocksValue += stock.amount * stock.currentPrice;
      });
      walletTotalEl.textContent = '$ ' + (balance + totalStocksValue).toFixed(2).replace('.', ',');
      walletStocksCountEl.textContent = ownedStocks.reduce((sum, s) => sum + s.amount, 0);

      // Обновляем бизнес
      renderBusinessList();

      // Обновляем рынок
      renderMarketList();

      // Обновляем кошелёк акций
      renderWalletStocks();
    }

    // Toast уведомления
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ================= БИЗНЕС =================
    createCompanyBtn.addEventListener('click', () => {
      const ownedCompanies = companies.filter(c => c.ownerId == telegramId);
      if (ownedCompanies.length >= 2) {
        showToast("Можно создать только 2 компании!");
        return;
      }
      createCompanyModal.classList.add('active');
    });

    closeCreateModal.addEventListener('click', () => {
      createCompanyModal.classList.remove('active');
    });

    confirmCreateCompany.addEventListener('click', async () => {
      const name = companyNameInput.value.trim();
      if (!name) {
        showToast("Введите название!");
        return;
      }
      if (!/^[a-zA-Z]+$/.test(name)) {
        showToast("Только английские буквы!");
        return;
      }
      if (companies.some(c => c.name === name)) {
        showToast("Компания с таким названием уже существует!");
        return;
      }

      const ownedCompanies = companies.filter(c => c.ownerId == telegramId);
      const cost = ownedCompanies.length === 0 ? 0 : 1000000;

      if (balance < cost) {
        showToast(`Недостаточно средств! Нужно $${cost}`);
        return;
      }

      try {
        const response = await fetch(`${apiBase}/companies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: telegramId,
            name: name,
            cost: cost
          })
        });

        if (!response.ok) throw new Error("Ошибка создания компании");

        const newCompany = await response.json();
        companies.push(newCompany);

        if (cost > 0) {
          balance -= cost;
          await fetch(`${apiBase}/update-balance/${telegramId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ balance: balance })
          });
        }

        showToast(`Компания "${name}" создана!`);
        createCompanyModal.classList.remove('active');
        companyNameInput.value = '';
        updateUI();

      } catch (err) {
        console.error('Create company error:', err);
        showToast("Ошибка при создании компании");
      }
    });

    function renderBusinessList() {
      const businessList = document.getElementById('business-list');
      businessList.innerHTML = '';

      const ownedCompanies = companies.filter(c => c.ownerId == telegramId);
      if (ownedCompanies.length === 0) {
        businessList.innerHTML = '<div class="card">У вас пока нет компаний. Создайте первую!</div>';
        return;
      }

      ownedCompanies.forEach(company => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = company.name;
        btn.addEventListener('click', () => openCompanyCabinet(company));
        businessList.appendChild(btn);
      });
    }

    function openCompanyCabinet(company) {
      document.getElementById('cabinet-company-name').textContent = company.name;
      document.getElementById('cabinet-clients').textContent = company.clients || 0;
      document.getElementById('cabinet-issued').textContent = company.issuedShares || 0;
      document.getElementById('cabinet-available').textContent = (company.clients || 0) * 1000 - (company.issuedShares || 0);

      companyCabinetModal.classList.add('active');
      window.currentCompany = company;
    }

    closeCompanyCabinet.addEventListener('click', () => {
      companyCabinetModal.classList.remove('active');
    });

    issueMoreSharesBtn.addEventListener('click', async () => {
      const company = window.currentCompany;
      if (!company) return;

      const available = (company.clients || 0) * 1000 - (company.issuedShares || 0);
      if (available <= 0) {
        showToast("Нет доступных акций для выпуска!");
        return;
      }

      try {
        const response = await fetch(`${apiBase}/companies/${company.id}/issue`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: available })
        });

        if (!response.ok) throw new Error("Ошибка выпуска акций");

        const updatedCompany = await response.json();
        // Обновляем компанию в списке
        const index = companies.findIndex(c => c.id === company.id);
        if (index !== -1) {
          companies[index] = updatedCompany;
        }

        showToast(`Выпущено ${available} акций!`);
        openCompanyCabinet(updatedCompany); // обновляем интерфейс кабинета

      } catch (err) {
        console.error('Issue shares error:', err);
        showToast("Ошибка выпуска акций");
      }
    });

    // ================= РЫНОК =================
    function renderMarketList() {
      const marketList = document.getElementById('market-list');
      marketList.innerHTML = '';

      if (marketStocks.length === 0) {
        marketList.innerHTML = '<div class="card">Нет доступных акций на рынке</div>';
        return;
      }

      marketStocks.forEach(stock => {
        const item = document.createElement('div');
        item.className = 'stock-item';
        item.innerHTML = `
          <div class="stock-info"><strong>${stock.companyName}</strong></div>
          <div class="stock-info">Владелец: ${stock.ownerName}</div>
          <div class="stock-info">Клиентов: ${stock.clients}</div>
          <div class="stock-info">Цена: $${stock.price.toFixed(2)}</div>
        `;
        item.addEventListener('click', () => openStockDetail(stock));
        marketList.appendChild(item);
      });
    }

    function openStockDetail(stock) {
      document.getElementById('stock-detail-title').textContent = stock.companyName;
      document.getElementById('stock-company-name').textContent = stock.companyName;
      document.getElementById('stock-owner').textContent = stock.ownerName;
      document.getElementById('stock-clients').textContent = stock.clients;
      document.getElementById('stock-price').textContent = '$' + stock.price.toFixed(2);
      buyAmountInput.value = 1;

      stockDetailModal.classList.add('active');
      window.currentStock = stock;
    }

    closeStockDetail.addEventListener('click', () => {
      stockDetailModal.classList.remove('active');
    });

    buyStockBtn.addEventListener('click', async () => {
      const stock = window.currentStock;
      if (!stock) return;

      const amount = parseInt(buyAmountInput.value);
      if (isNaN(amount) || amount <= 0) {
        showToast("Введите корректное количество!");
        return;
      }

      const totalCost = stock.price * amount;
      if (balance < totalCost) {
        showToast("Недостаточно средств!");
        return;
      }

      try {
        const response = await fetch(`${apiBase}/stocks/buy`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            buyer_telegram_id: telegramId,
            company_id: stock.companyId,
            amount: amount
          })
        });

        if (!response.ok) throw new Error("Ошибка покупки акций");

        const result = await response.json();

        // Обновляем баланс
        balance -= totalCost;
        await fetch(`${apiBase}/update-balance/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance: balance })
        });

        // Обновляем список акций в кошельке
        const existingStockIndex = ownedStocks.findIndex(s => s.companyId === stock.companyId);
        if (existingStockIndex !== -1) {
          ownedStocks[existingStockIndex].amount += amount;
          // buyPrice не меняем — усредняем только при продаже или новой покупке по другой цене
        } else {
          ownedStocks.push({
            companyId: stock.companyId,
            companyName: stock.companyName,
            amount: amount,
            buyPrice: stock.price,
            currentPrice: stock.price
          });
        }

        // Обновляем компанию (клиентов)
        const companyIndex = companies.findIndex(c => c.id === stock.companyId);
        if (companyIndex !== -1) {
          companies[companyIndex].clients = result.newClientCount;
        }

        showToast(`Куплено ${amount} акций компании ${stock.companyName}!`);
        stockDetailModal.classList.remove('active');
        updateUI();

      } catch (err) {
        console.error('Buy stock error:', err);
        showToast("Ошибка покупки акций");
      }
    });

    // ================= КОШЕЛЕК =================
    function renderWalletStocks() {
      const walletStocksList = document.getElementById('wallet-stocks-list');
      walletStocksList.innerHTML = '';

      if (ownedStocks.length === 0) {
        walletStocksList.innerHTML = '<div class="card">У вас нет акций</div>';
        return;
      }

      ownedStocks.forEach(stock => {
        const item = document.createElement('div');
        item.className = 'wallet-stock-item';
        const profit = (stock.currentPrice - stock.buyPrice) * stock.amount;
        item.innerHTML = `
          <div class="stat-row">
            <span>${stock.companyName}</span>
            <span>${stock.amount} шт.</span>
          </div>
          <div class="stat-row">
            <span>Куплено за: $${stock.buyPrice.toFixed(2)}</span>
            <span>Текущая: $${stock.currentPrice.toFixed(2)}</span>
          </div>
          <div class="stat-row">
            <span>Доход: $${profit.toFixed(2)}</span>
            <span style="color: ${profit >= 0 ? 'green' : 'red'};">${profit >= 0 ? '+' : ''}${profit.toFixed(2)}</span>
          </div>
        `;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'wallet-stock-actions';

        const sellBtn = document.createElement('button');
        sellBtn.className = 'btn';
        sellBtn.textContent = 'Продать';
        sellBtn.addEventListener('click', () => sellStock(stock));
        actionsDiv.appendChild(sellBtn);

        item.appendChild(actionsDiv);
        walletStocksList.appendChild(item);
      });
    }

    async function sellStock(stock) {
      const amount = prompt(`Сколько акций продать? (макс: ${stock.amount})`, 1);
      if (!amount) return;

      const sellAmount = parseInt(amount);
      if (isNaN(sellAmount) || sellAmount <= 0 || sellAmount > stock.amount) {
        showToast("Некорректное количество!");
        return;
      }

      try {
        const response = await fetch(`${apiBase}/stocks/sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seller_telegram_id: telegramId,
            company_id: stock.companyId,
            amount: sellAmount
          })
        });

        if (!response.ok) throw new Error("Ошибка продажи акций");

        const result = await response.json();

        // Обновляем баланс
        balance += result.totalReceived;
        await fetch(`${apiBase}/update-balance/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance: balance })
        });

        // Обновляем список акций
        const stockIndex = ownedStocks.findIndex(s => s.companyId === stock.companyId);
        if (stockIndex !== -1) {
          ownedStocks[stockIndex].amount -= sellAmount;
          if (ownedStocks[stockIndex].amount <= 0) {
            ownedStocks.splice(stockIndex, 1);
          }
        }

        showToast(`Продано ${sellAmount} акций за $${result.totalReceived.toFixed(2)}!`);
        updateUI();

      } catch (err) {
        console.error('Sell stock error:', err);
        showToast("Ошибка продажи акций");
      }
    }

    // ================= ИНИЦИАЛИЗАЦИЯ =================
    async function initApp() {
      try {
        // Загружаем данные пользователя
        const userRes = await fetch(`${apiBase}/user/${telegramId}`);
        if (userRes.ok) {
          const user = await userRes.json();
          balance = parseFloat(user.balance);
          level = user.level;
          progress = parseFloat(user.progress);
          totalClicks = user.total_clicks;
        }

        // Загружаем компании
        const companiesRes = await fetch(`${apiBase}/companies`);
        if (companiesRes.ok) {
          companies = await companiesRes.json();
        }

        // Загружаем акции пользователя
        const stocksRes = await fetch(`${apiBase}/stocks?telegram_id=${telegramId}`);
        if (stocksRes.ok) {
          ownedStocks = await stocksRes.json();
        }

        // Загружаем рынок
        const marketRes = await fetch(`${apiBase}/market`);
        if (marketRes.ok) {
          marketStocks = await marketRes.json();
        }

        updateUI();
      } catch (err) {
        console.error('Init error:', err);
        showToast("Ошибка загрузки данных");
      }
    }

    // Инициализация
    initApp();
  </script>

</body>
</html>
