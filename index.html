<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Empire Richman</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: white;
      color: black;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      padding-bottom: 72px; /* место под навигацию */
    }

    .section {
      display: none;
      padding: 20px;
    }

    .section.active {
      display: block;
    }

    .bank-card {
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 20px;
    }

    .clicker-area {
      text-align: center;
      margin: 20px 0;
    }

    #tap-circle {
      width: 100px;
      height: 100px;
      background: #e0e0e0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin: 20px 0;
    }

    .card {
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
    }

    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 72px;
      background: white;
      border-top: 1px solid #ccc;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .nav-item {
      text-align: center;
      cursor: pointer;
    }

    .nav-item.active {
      font-weight: bold;
    }

    #toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- Верхняя панель -->
  <div class="header">
    <h1>Richman</h1>
  </div>

  <!-- Основной контент -->
  <div class="main-content">
    
    <!-- Главная (кликер) -->
    <div class="section active" id="home-section">
      <!-- Банковская карта -->
      <div class="bank-card">
        <div>
          <div>RICHMAN</div>
          <div>•••• •••• •••• 1234</div>
        </div>
        <div>
          <div>Баланс: <span id="card-balance">$ 65,00</span></div>
          <div>Уровень: <span id="card-level">1</span></div>
        </div>
      </div>
      
      <div class="clicker-area">
        <div id="tap-circle">TAP</div>
        <div>Кликайте, чтобы зарабатывать деньги</div>
      </div>
    </div>

    <!-- Бизнес -->
    <div class="section" id="business-section">
      <h2>Бизнес</h2>
      <div class="card">
        <p>Функционал бизнеса отключен</p>
      </div>
    </div>

    <!-- Рынок -->
    <div class="section" id="market-section">
      <h2>Рынок акций</h2>
      <div class="card">
        <p>Функционал рынка отключен</p>
      </div>
    </div>

    <!-- Кошелек -->
    <div class="section" id="wallet-section">
      <h2>Кошелек</h2>
      <div class="card">
        <div>Баланс: <span id="wallet-balance">$ 65,00</span></div>
        <div>Акции: 0</div>
        <div>Общая стоимость: <span id="wallet-total">$ 65,00</span></div>
      </div>
    </div>

    <!-- Профиль -->
    <div class="section" id="profile-section">
      <h2>Профиль</h2>
      
      <div style="text-align: center; margin-bottom: 20px;">
        <div id="profile-avatar" style="width: 80px; height: 80px; margin: 0 auto 10px; background: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <img id="avatar-img" src="" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
        </div>
        <div id="profile-name">Richman Player</div>
        <div id="profile-username">@username</div>
        <div>Уровень <span id="profile-level">1</span></div>
      </div>

      <div class="card">
        <div>ID игрока: <span id="player-id">#74291</span></div>
        <div>Всего кликов: <span id="total-clicks">0</span></div>
        <div>Прогресс до следующего уровня: <span id="progress-percent">60%</span></div>
      </div>
      
      <div class="card">
        <div>
          <div style="height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
            <div id="progress-fill" style="height: 100%; background: gray; width: 60%;"></div>
          </div>
          <div style="text-align: center; margin-top: 5px;" id="progress-text">$1 000,00 / $2 000,00</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Нижняя навигация -->
  <div class="bottom-nav">
    <div class="nav-item active" data-section="home">
      <div>Главная</div>
    </div>
    <div class="nav-item" data-section="business">
      <div>Бизнес</div>
    </div>
    <div class="nav-item" data-section="market">
      <div>Рынок</div>
    </div>
    <div class="nav-item" data-section="wallet">
      <div>Кошелек</div>
    </div>
    <div class="nav-item" data-section="profile">
      <div>Профиль</div>
    </div>
  </div>

  <!-- Toast уведомление -->
  <div id="toast"></div>

  <script>
    // Telegram WebApp init — НЕ ТРОГАЕМ
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Глобальные переменные — НЕ ТРОГАЕМ
    let userData = tg.initDataUnsafe.user || {};
    let telegramId = userData.id || 0;
    let balance = 65.00;
    let clickValue = 2.50;
    let level = 1;
    let progress = 600; // из 1000
    let totalClicks = 0;
    let apiBase = 'https://dinod.ru/api';

    // DOM элементы — НЕ ТРОГАЕМ
    const themeToggle = document.getElementById('theme-toggle');
    const htmlRoot = document.getElementById('html-root');
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const tapCircle = document.getElementById('tap-circle');
    const cardBalanceEl = document.getElementById('card-balance');
    const cardLevelEl = document.getElementById('card-level');
    const progressFillEl = document.getElementById('progress-fill');
    const progressTextEl = document.getElementById('progress-text');
    const progressPercentEl = document.getElementById('progress-percent');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const walletTotalEl = document.getElementById('wallet-total');
    const profileLevelEl = document.getElementById('profile-level');
    const totalClicksEl = document.getElementById('total-clicks');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileUsernameEl = document.getElementById('profile-username');
    const playerIdEl = document.getElementById('player-id');
    const avatarImgEl = document.getElementById('avatar-img');

    // Load user data from server — НЕ ТРОГАЕМ
    async function loadUserData() {
      if (!telegramId) return;
      try {
        const response = await fetch(`${apiBase}/user/${telegramId}`);
        const user = await response.json();
        if (user) {
          balance = parseFloat(user.balance) || 65.00;
          level = user.level || 1;
          progress = parseFloat(user.progress) || 0;
          totalClicks = user.total_clicks || 0;
          clickValue = 2.50 * level;

          // Update profile
          profileNameEl.textContent = user.first_name || 'Player';
          if (user.username) {
            profileUsernameEl.textContent = `@${user.username}`;
          } else {
            profileUsernameEl.textContent = '';
          }
          playerIdEl.textContent = `#${user.telegram_id}`;

          // Avatar
          if (user.avatar_url) {
            avatarImgEl.src = user.avatar_url;
            avatarImgEl.style.display = 'block';
            profileAvatarEl.style.background = 'none';
          } else {
            // Fallback initials
            const initials = (user.first_name || 'P').charAt(0).toUpperCase();
            profileAvatarEl.innerHTML = initials;
          }
        }
      } catch (err) {
        console.error('Load user error:', err);
      }
      updateUI();
    }

    // Переключение разделов — НЕ ТРОГАЕМ
    function switchToSection(sectionId) {
      sections.forEach(section => section.classList.remove('active'));
      navItems.forEach(item => item.classList.remove('active'));
      
      document.getElementById(`${sectionId}-section`).classList.add('active');
      document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
      
      updateUI();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.getAttribute('data-section');
        switchToSection(sectionId);
      });
    });

    // Handle click with server sync — НЕ ТРОГАЕМ
    async function handleClick() {
      if (!telegramId) return;

      try {
        const response = await fetch(`${apiBase}/click/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance, total_clicks: totalClicks })
        });
        const updatedUser = await response.json();
        if (updatedUser) {
          balance = parseFloat(updatedUser.balance);
          level = updatedUser.level;
          progress = parseFloat(updatedUser.progress);
          totalClicks = updatedUser.total_clicks;
          clickValue = 2.50 * level;

          if (updatedUser.level > level) { // Level up check
            showToast(`🎉 Новый уровень! Теперь вы зарабатываете $${clickValue.toFixed(2)} за клик`);
          }
        }
      } catch (err) {
        console.error('Click error:', err);
      }

      updateUI();

      // Анимация клика (упрощенная)
      tapCircle.style.transform = 'scale(0.95)';
      setTimeout(() => {
        tapCircle.style.transform = 'scale(1)';
      }, 200);
    }

    tapCircle.addEventListener('click', handleClick);

    // Sync balance every 30 seconds — НЕ ТРОГАЕМ
    setInterval(async () => {
      if (!telegramId) return;
      try {
        await fetch(`${apiBase}/update-balance/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance })
        });
      } catch (err) {
        console.error('Sync error:', err);
      }
    }, 30000);

    // Обновление UI — НЕ ТРОГАЕМ
    function updateUI() {
      const formattedBalance = '$ ' + balance.toFixed(2).replace('.', ',');
      cardBalanceEl.textContent = formattedBalance;
      walletBalanceEl.textContent = formattedBalance;
      cardLevelEl.textContent = level;
      profileLevelEl.textContent = level;
      
      const nextThreshold = level * 1000;
      const progressPercent = Math.min(100, Math.round((progress / nextThreshold) * 100));
      progressFillEl.style.width = `${progressPercent}%`;
      progressTextEl.textContent = `$${progress.toFixed(0)} / $${nextThreshold.toFixed(0)}`;
      progressPercentEl.textContent = `${progressPercent}%`;

      walletTotalEl.textContent = '$ ' + balance.toFixed(2).replace('.', ',');
      totalClicksEl.textContent = totalClicks;
    }

    // Toast уведомления — НЕ ТРОГАЕМ
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Инициализация — НЕ ТРОГАЕМ
    loadUserData();
  </script>

</body>
</html>
