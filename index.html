<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Empire Richman</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background: white; color: black; min-height: 100vh; padding-bottom: 72px; }
    .header { padding: 20px; font-size: 24px; font-weight: bold; }
    .main-content { padding: 0 20px; }
    .section { display: none; }
    .section.active { display: block; }
    .card { background: white; border: 1px solid #ccc; padding: 20px; margin-bottom: 16px; }
    .bank-card { background: white; border: 1px solid #ccc; padding: 20px; margin-bottom: 24px; }
    .tap-circle { width: 120px; height: 120px; border-radius: 50%; background: white; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; }
    .tap-text { text-align: center; margin: 10px 0; }
    .btn { padding: 12px; background: white; border: 1px solid #ccc; cursor: pointer; margin: 8px 0; text-align: center; }
    .bottom-nav { display: flex; justify-content: space-around; position: fixed; bottom: 0; left: 0; right: 0; height: 72px; background: white; border-top: 1px solid #ccc; }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; padding: 8px 0; }
    .nav-item.active { color: black; font-weight: bold; }
    #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid #ccc; padding: 12px 24px; border-radius: 4px; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
    #toast.show { opacity: 1; }
    .section-title { font-size: 22px; font-weight: bold; margin: 20px 0 10px; }
    .profile-header { text-align: center; margin-bottom: 20px; }
    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; }
    .profile-level, .stat-row { margin: 8px 0; }
    .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .progress-container { width: 100%; height: 8px; background: #eee; margin: 10px 0; }
    .progress-fill { height: 100%; background: #ccc; width: 0%; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; }
    .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 16px; }
    .input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; }
    .company-list { margin-top: 16px; }
    .stock-item { padding: 12px; border: 1px solid #ddd; margin: 8px 0; cursor: pointer; }
    .wallet-stock { padding: 12px; border: 1px solid #ddd; margin: 8px 0; }
    .profit { color: green; }
    .loss { color: red; }
  </style>
</head>
<body>

  <div class="header">Richman</div>

  <div class="main-content">
    <!-- Главная -->
    <div class="section active" id="home-section">
      <div class="bank-card">
        <div>RICHMAN</div>
        <div>•••• •••• •••• 1234</div>
        <div>
          <div>Баланс: <span id="card-balance">$ 65,00</span></div>
          <div>Уровень: <span id="card-level">1</span></div>
        </div>
      </div>
      <div class="clicker-area">
        <div class="tap-circle" id="tap-circle">
          <i class="fas fa-hand-point-up" style="font-size: 40px;"></i>
        </div>
        <div class="tap-text">Кликайте, чтобы зарабатывать деньги</div>
      </div>
    </div>

    <!-- Бизнес -->
    <div class="section" id="business-section">
      <h2 class="section-title">Бизнес</h2>
      <div class="btn" id="create-company-btn">➕ Создать компанию</div>
      <div id="company-list" class="company-list"></div>
    </div>

    <!-- Рынок -->
    <div class="section" id="market-section">
      <h2 class="section-title">Рынок акций</h2>
      <div id="market-list"></div>
    </div>

    <!-- Кошелек -->
    <div class="section" id="wallet-section">
      <h2 class="section-title">Кошелек</h2>
      <div class="card">
        <div class="stat-row">
          <span>Баланс</span>
          <span id="wallet-balance">$ 65,00</span>
        </div>
        <div class="stat-row">
          <span>Акции</span>
          <span id="wallet-stocks-count">0</span>
        </div>
        <div class="stat-row">
          <span>Общая стоимость</span>
          <span id="wallet-total">$ 65,00</span>
        </div>
      </div>
      <div id="wallet-stocks-list"></div>
    </div>

    <!-- Профиль -->
    <div class="section" id="profile-section">
      <h2 class="section-title">Профиль</h2>
      <div class="profile-header">
        <div class="profile-avatar" id="profile-avatar">
          <img id="avatar-img" src="" alt="Avatar" style="display: none; width: 100%; height: 100%; border-radius: 50%;">
        </div>
        <div class="profile-name" id="profile-name">Richman Player</div>
        <div class="profile-username" id="profile-username">@username</div>
        <div class="profile-level">Уровень <span id="profile-level">1</span></div>
      </div>
      <div class="card">
        <div class="stat-row">
          <span>ID игрока</span>
          <span id="player-id">#74291</span>
        </div>
        <div class="stat-row">
          <span>Всего кликов</span>
          <span id="total-clicks">0</span>
        </div>
        <div class="stat-row">
          <span>Прогресс до следующего уровня</span>
          <span id="progress-percent">60%</span>
        </div>
      </div>
      <div class="card">
        <div class="progress-container">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div style="text-align: center; margin-top: 8px;" id="progress-text">$1 000,00 / $2 000,00</div>
      </div>
    </div>
  </div>

  <!-- Модальные окна -->
  <div class="modal" id="create-company-modal">
    <div class="modal-content">
      <div class="modal-title">Создать компанию</div>
      <input type="text" class="input" id="company-name-input" placeholder="Название (только английские буквы)">
      <div class="btn" id="confirm-create-company">Создать</div>
      <div class="btn" id="cancel-create-company">Отмена</div>
    </div>
  </div>

  <div class="modal" id="company-modal">
    <div class="modal-content">
      <div class="modal-title" id="company-modal-title">Личный кабинет компании</div>
      <div>Клиентов: <span id="company-clients">0</span></div>
      <div>Доступно к выпуску: <span id="company-available-shares">0</span></div>
      <div class="btn" id="issue-shares-btn">Выпустить акции</div>
      <div class="btn" id="close-company-modal">Закрыть</div>
    </div>
  </div>

  <div class="modal" id="stock-modal">
    <div class="modal-content">
      <div class="modal-title" id="stock-modal-title">Купить акции</div>
      <div>Владелец: <span id="stock-owner"></span></div>
      <div>Клиентов: <span id="stock-clients"></span></div>
      <div>Цена за акцию: <span id="stock-price"></span></div>
      <input type="number" class="input" id="stock-quantity" placeholder="Количество" min="1" value="1">
      <div class="btn" id="buy-stock-btn">Купить</div>
      <div class="btn" id="close-stock-modal">Отмена</div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-section="home">
      <i class="fas fa-home"></i><span>Главная</span>
    </div>
    <div class="nav-item" data-section="business">
      <i class="fas fa-building"></i><span>Бизнес</span>
    </div>
    <div class="nav-item" data-section="market">
      <i class="fas fa-chart-line"></i><span>Рынок</span>
    </div>
    <div class="nav-item" data-section="wallet">
      <i class="fas fa-wallet"></i><span>Кошелек</span>
    </div>
    <div class="nav-item" data-section="profile">
      <i class="fas fa-user"></i><span>Профиль</span>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let userData = tg.initDataUnsafe.user || {};
    let telegramId = userData.id || 0;
    let balance = 65.00;
    let clickValue = 2.50;
    let level = 1;
    let progress = 600;
    let totalClicks = 0;
    let companies = [];
    let stocks = [];
    let walletStocks = [];

    const apiBase = 'https://dinod.ru/api';

    // DOM Elements
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');
    const tapCircle = document.getElementById('tap-circle');
    const cardBalanceEl = document.getElementById('card-balance');
    const cardLevelEl = document.getElementById('card-level');
    const progressFillEl = document.getElementById('progress-fill');
    const progressTextEl = document.getElementById('progress-text');
    const progressPercentEl = document.getElementById('progress-percent');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const walletTotalEl = document.getElementById('wallet-total');
    const profileLevelEl = document.getElementById('profile-level');
    const totalClicksEl = document.getElementById('total-clicks');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileUsernameEl = document.getElementById('profile-username');
    const playerIdEl = document.getElementById('player-id');
    const avatarImgEl = document.getElementById('avatar-img');
    const companyListEl = document.getElementById('company-list');
    const marketListEl = document.getElementById('market-list');
    const walletStocksListEl = document.getElementById('wallet-stocks-list');
    const walletStocksCountEl = document.getElementById('wallet-stocks-count');

    // Modals
    const createCompanyModal = document.getElementById('create-company-modal');
    const companyModal = document.getElementById('company-modal');
    const stockModal = document.getElementById('stock-modal');
    const companyNameInput = document.getElementById('company-name-input');
    const confirmCreateCompanyBtn = document.getElementById('confirm-create-company');
    const cancelCreateCompanyBtn = document.getElementById('cancel-create-company');
    const closeCompanyModalBtn = document.getElementById('close-company-modal');
    const issueSharesBtn = document.getElementById('issue-shares-btn');
    const closeStockModalBtn = document.getElementById('close-stock-modal');
    const buyStockBtn = document.getElementById('buy-stock-btn');
    const createCompanyBtn = document.getElementById('create-company-btn');

    // Modal Controls
    function showModal(modal) { modal.style.display = 'flex'; }
    function hideModal(modal) { modal.style.display = 'none'; }

    // Navigation
    function switchToSection(sectionId) {
      sections.forEach(s => s.classList.remove('active'));
      navItems.forEach(n => n.classList.remove('active'));
      document.getElementById(`${sectionId}-section`).classList.add('active');
      document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
      if (sectionId === 'business') loadCompanies();
      if (sectionId === 'market') loadMarket();
      if (sectionId === 'wallet') loadWalletStocks();
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const sectionId = item.getAttribute('data-section');
        switchToSection(sectionId);
      });
    });

    // Click Handler
    async function handleClick() {
      if (!telegramId) return;
      try {
        const res = await fetch(`${apiBase}/click/${telegramId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ balance, total_clicks: totalClicks })
        });
        const user = await res.json();
        if (user) {
          balance = parseFloat(user.balance);
          level = user.level;
          progress = parseFloat(user.progress);
          totalClicks = user.total_clicks;
          clickValue = 2.50 * level;
          updateUI();
        }
      } catch (err) { console.error(err); }
    }

    tapCircle.addEventListener('click', handleClick);

    // UI Update
    function updateUI() {
      const formatted = '$ ' + balance.toFixed(2).replace('.', ',');
      cardBalanceEl.textContent = walletBalanceEl.textContent = walletTotalEl.textContent = formatted;
      cardLevelEl.textContent = profileLevelEl.textContent = level;
      const next = level * 1000;
      const percent = Math.min(100, Math.round((progress / next) * 100));
      progressFillEl.style.width = `${percent}%`;
      progressTextEl.textContent = `$${progress.toFixed(0)} / $${next.toFixed(0)}`;
      progressPercentEl.textContent = `${percent}%`;
      totalClicksEl.textContent = totalClicks;
      playerIdEl.textContent = `#${telegramId}`;
      profileNameEl.textContent = userData.first_name || 'Richman Player';
      profileUsernameEl.textContent = userData.username ? `@${userData.username}` : '@username';
      if (userData.photo_url) {
        avatarImgEl.src = userData.photo_url;
        avatarImgEl.style.display = 'block';
      }
    }

    // Toast
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Business
    createCompanyBtn.addEventListener('click', () => {
      showModal(createCompanyModal);
    });

    cancelCreateCompanyBtn.addEventListener('click', () => {
      hideModal(createCompanyModal);
    });

    confirmCreateCompanyBtn.addEventListener('click', async () => {
      const name = companyNameInput.value.trim();
      if (!/^[a-zA-Z]+$/.test(name)) {
        showToast("Только английские буквы!");
        return;
      }
      try {
        const res = await fetch(`${apiBase}/company/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: telegramId, name })
        });
        const result = await res.json();
        if (result.success) {
          showToast("Компания создана!");
          hideModal(createCompanyModal);
          companyNameInput.value = '';
          loadCompanies();
        } else {
          showToast(result.error || "Ошибка");
        }
      } catch (err) {
        console.error(err);
        showToast("Ошибка сервера");
      }
    });

    // Load Companies
    async function loadCompanies() {
      try {
        const res = await fetch(`${apiBase}/company/list?telegram_id=${telegramId}`);
        const data = await res.json();
        companies = data.companies || [];
        companyListEl.innerHTML = '';
        companies.forEach(c => {
          const btn = document.createElement('div');
          btn.className = 'btn';
          btn.textContent = c.name;
          btn.addEventListener('click', () => openCompanyModal(c));
          companyListEl.appendChild(btn);
        });
      } catch (err) { console.error(err); }
    }

    // Company Modal
    function openCompanyModal(company) {
      document.getElementById('company-modal-title').textContent = company.name;
      document.getElementById('company-clients').textContent = company.clients;
      document.getElementById('company-available-shares').textContent = company.available_shares;
      issueSharesBtn.onclick = async () => {
        try {
          const res = await fetch(`${apiBase}/company/issue-shares`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telegram_id: telegramId, company_id: company.id })
          });
          const result = await res.json();
          if (result.success) {
            showToast("Акции выпущены!");
            openCompanyModal(company); // refresh
            loadMarket();
          } else {
            showToast(result.error);
          }
        } catch (err) {
          console.error(err);
          showToast("Ошибка");
        }
      };
      showModal(companyModal);
    }

    closeCompanyModalBtn.addEventListener('click', () => hideModal(companyModal));

    // Market
    async function loadMarket() {
      try {
        const res = await fetch(`${apiBase}/market/list`);
        const data = await res.json();
        stocks = data.stocks || [];
        marketListEl.innerHTML = '';
        stocks.forEach(s => {
          const item = document.createElement('div');
          item.className = 'stock-item';
          item.innerHTML = `
            <strong>${s.company_name}</strong><br>
            Владелец: ${s.owner_username}<br>
            Клиентов: ${s.clients}<br>
            Цена: $${s.price.toFixed(2)}
          `;
          item.addEventListener('click', () => openStockModal(s));
          marketListEl.appendChild(item);
        });
      } catch (err) { console.error(err); }
    }

    // Stock Modal
    function openStockModal(stock) {
      document.getElementById('stock-modal-title').textContent = stock.company_name;
      document.getElementById('stock-owner').textContent = stock.owner_username;
      document.getElementById('stock-clients').textContent = stock.clients;
      document.getElementById('stock-price').textContent = `$${stock.price.toFixed(2)}`;
      document.getElementById('stock-quantity').value = 1;
      buyStockBtn.onclick = async () => {
        const qty = parseInt(document.getElementById('stock-quantity').value);
        if (qty < 1) return showToast("Минимум 1 акция");
        try {
          const res = await fetch(`${apiBase}/market/buy`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telegram_id: telegramId, stock_id: stock.id, quantity: qty })
          });
          const result = await res.json();
          if (result.success) {
            showToast("Акции куплены!");
            hideModal(stockModal);
            loadWalletStocks();
            loadMarket();
            loadCompanies(); // обновить клиентов
          } else {
            showToast(result.error);
          }
        } catch (err) {
          console.error(err);
          showToast("Ошибка");
        }
      };
      showModal(stockModal);
    }

    closeStockModalBtn.addEventListener('click', () => hideModal(stockModal));

    // Wallet Stocks
    async function loadWalletStocks() {
      try {
        const res = await fetch(`${apiBase}/wallet/stocks?telegram_id=${telegramId}`);
        const data = await res.json();
        walletStocks = data.stocks || [];
        walletStocksListEl.innerHTML = '';
        let totalShares = 0;
        walletStocks.forEach(ws => {
          totalShares += ws.quantity;
          const item = document.createElement('div');
          item.className = 'wallet-stock';
          const currentPrice = ws.current_price || ws.purchase_price;
          const profit = (currentPrice - ws.purchase_price) * ws.quantity;
          const profitClass = profit >= 0 ? 'profit' : 'loss';
          const profitText = profit >= 0 ? `+ $${profit.toFixed(2)}` : `- $${Math.abs(profit).toFixed(2)}`;
          item.innerHTML = `
            <strong>${ws.company_name}</strong> (${ws.quantity} шт.)<br>
            Куплено за: $${ws.purchase_price.toFixed(2)}<br>
            Сейчас: $${currentPrice.toFixed(2)}<br>
            <span class="${profitClass}">${profitText}</span><br>
            <button class="btn sell-btn" data-id="${ws.id}">Продать</button>
          `;
          walletStocksListEl.appendChild(item);
        });
        walletStocksCountEl.textContent = totalShares;
        document.querySelectorAll('.sell-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            try {
              const res = await fetch(`${apiBase}/wallet/sell`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: telegramId, wallet_stock_id: id })
              });
              const result = await res.json();
              if (result.success) {
                showToast("Акции проданы!");
                loadWalletStocks();
                loadMarket();
              } else {
                showToast(result.error);
              }
            } catch (err) {
              console.error(err);
              showToast("Ошибка");
            }
          });
        });
      } catch (err) { console.error(err); }
    }

    // Init
    updateUI();
  </script>
</body>
</html>
